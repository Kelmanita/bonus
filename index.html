<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bonus dashboard</title>

<style>
html, body {
  margin:0; padding:0;
  width:100vw; height:100vh;
  overflow:hidden;
  background:#fff;
  font-family: Arial, sans-serif;
}

body { font-size:18px; }

.wrap { height:100vh; display:flex; flex-direction:column; }

.topbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:14px 18px;
  border-bottom:1px solid #eee;
}
.title { font-size:22px; font-weight:800; }
.status { font-size:16px; opacity:.7; }

.grid {
  flex:1;
  display:grid;
  grid-template-rows: 2fr 1fr;
  gap:14px;
  padding:14px 18px;
  box-sizing:border-box;
}

.row2 {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}

.card {
  border:1px solid #eee;
  border-radius:14px;
  padding:14px;
  overflow:hidden;
}

.card h2 {
  margin:0 0 10px 0;
  font-size:22px;
  display:flex; gap:10px; align-items:center;
}

.pill {
  font-size:14px;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid #eee;
  background:#fafafa;
}

/* ===== –î–∏–∞–≥—Ä–∞–º–º–∞ ===== */
.vchart {
  height:100%;
  display:grid;
  grid-template-rows: 24px 1fr 70px; /* ‚Üì —É–º–µ–Ω—å—à–∏–ª–∏ –Ω–∏–∑ */
  gap:8px;
}

.cap {
  display:flex; justify-content:space-between;
  font-size:15px; opacity:.75;
}

.plot {
  position:relative;
  border:1px solid #eee;
  border-radius:12px;
  background:
    linear-gradient(to bottom, rgba(0,0,0,.08) 1px, transparent 1px);
  background-size:100% 20%;
}

.columns {
  position:absolute;
  inset:10px;
  display:grid;
  align-items:stretch;
  gap:6px;
}

.col {
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  align-items:center;
}

.val {
  font-size:14px;
  font-weight:800;
  margin-bottom:4px;
}

.bar {
  width:100%;
  border-radius:8px 8px 0 0;
  min-height:3px;
  transition:height .3s;
}

/* –ø–æ–¥–ø–∏—Å–∏ */
.xlabels {
  display:grid;
  padding:0 10px;
}

.xlabel {
  white-space:nowrap;
  font-size:clamp(11px, 0.9vw, 14px);
  font-weight:700;
  transform:rotate(-22deg);
  transform-origin:top center;
}

/* ===== –ª–∏–Ω–∏—è —Ü–µ–ª–∏ ===== */
.targetLine {
  position:absolute; left:0; right:0;
  height:2px;
  background:#e11d48;
}
.targetLabel {
  position:absolute;
  right:8px;
  font-size:13px;
  font-weight:900;
  color:#e11d48;
  background:#fff;
  padding:2px 6px;
  border-radius:999px;
}

/* ===== –¢–∞–±–ª–∏—Ü–∞ ===== */
#sumTableWrap { height:100%; overflow:hidden; }

.sumTable {
  width:100%;
  height:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:22px;
}

.sumTable th, .sumTable td {
  border:2px solid #222;
  padding:8px 10px;   /* ‚Üì –ø–æ–¥–æ–≥–Ω–∞–ª–∏ */
  line-height:1.1;
}

.sumHead {
  background:#93c47d;
  font-size:26px;
  font-weight:900;
  text-align:center;
}

.sumLabel { font-weight:900; text-align:center; }
.sumVal { font-weight:900; text-align:right; }

</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Bonus dashboard</div>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>RU <span class="pill">–¥–∞–Ω–Ω—ã–µ!G2:H28</span></h2>
      <div id="chartRU"></div>
    </div>

    <div class="row2">
      <div class="card">
        <h2>ENG / PL <span class="pill">–¥–∞–Ω–Ω—ã–µ!C2:D8</span></h2>
        <div id="chartENGPL"></div>
      </div>

      <div class="card">
        <h2>Team ratings <span class="pill">–¥–∞–Ω–Ω—ã–µ!P18:Q21</span></h2>
        <div id="sumTableWrap"></div>
      </div>
    </div>
  </div>
</div>

<script>
const SPREADSHEET_ID = "123_11_j3y3KJhh45yomAOSFp3qP0Un7ePHxjcXQEhfs";
const GID = "1932060383";

const TARGET = 150000;

const RANGES = {
  ru: "G2:H28",
  engpl: "C2:D8",
  sums: "P18:Q21"
};

function csvUrl(range){
  return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID}&range=${range}&t=${Date.now()}`;
}

function parseCSV(t){
  return t.trim().split("\n").map(r => r.split(","));
}

function num(v){ return Number(String(v).replace(/\s/g,"")) || 0; }

function color(name){
  let h=0; for(let c of name) h = (h*31 + c.charCodeAt(0))%360;
  return `hsl(${h},70%,45%)`;
}

function renderChart(el, data){
  data = data.map(r=>({name:r[0], val:num(r[1])}));

  el.innerHTML = `
  <div class="vchart">
    <div class="cap">
      <div>0</div>
      <div>MAX: ${TARGET} ‚Ä¢ –¶–ï–õ–¨ ${TARGET}</div>
    </div>
    <div class="plot">
      <div class="targetLine" style="bottom:100%"></div>
      <div class="targetLabel" style="top:6px">–¶–ï–õ–¨ 150000</div>
      <div class="columns"></div>
    </div>
    <div class="xlabels"></div>
  </div>`;

  const cols = el.querySelector(".columns");
  const labs = el.querySelector(".xlabels");

  cols.style.gridTemplateColumns = labs.style.gridTemplateColumns =
    `repeat(${data.length},1fr)`;

  cols.innerHTML = data.map(d=>{
    const h = Math.max(3, d.val / TARGET * 100);
    return `<div class="col">
      <div class="val">${d.val}</div>
      <div class="bar" style="height:${h}%;background:${color(d.name)}"></div>
    </div>`;
  }).join("");

  labs.innerHTML = data.map(d=>`<div class="xlabel">${d.name}</div>`).join("");
}

function renderTable(el, data){
  el.innerHTML = `
  <table class="sumTable">
    <tr><th class="sumHead" colspan="2">Team ratings üìä</th></tr>
    ${data.map(r=>`
      <tr>
        <td class="sumLabel">${r[0]}</td>
        <td class="sumVal">${num(r[1])}</td>
      </tr>`).join("")}
  </table>`;
}

async function load(){
  const [ru, engpl, sums] = await Promise.all(
    Object.values(RANGES).map(r=>fetch(csvUrl(r)).then(x=>x.text()).then(parseCSV))
  );
  renderChart(chartRU, ru);
  renderChart(chartENGPL, engpl);
  renderTable(sumTableWrap, sums);

  status.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
}

load();
setInterval(load, 30000);
</script>
</body>
</html>
