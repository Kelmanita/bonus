<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonus Dashboard</title>

  <style>
    html, body {
      margin:0; padding:0;
      width:100vw; height:100vh;
      overflow:hidden;
      background:#fff;
      font-family: Arial, sans-serif;
    }
    body { font-size: 18px; }

    .wrap { height:100vh; display:flex; flex-direction:column; }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 18px;
      border-bottom:1px solid #eee;
    }
    .title{ font-size:22px; font-weight:800; }
    .status{ font-size:16px; opacity:.75; white-space:nowrap; }

    .grid{
      flex:1;
      display:grid;
      grid-template-rows: 2fr 1fr;
      gap:14px;
      padding:14px 18px;
      box-sizing:border-box;
      min-height:0;
    }

    /* ‚Üì –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É–∂–µ, –¥–∏–∞–≥—Ä–∞–º–º—É —à–∏—Ä–µ (—á—Ç–æ–±—ã –∏–º–µ–Ω–∞ –≤–ª–µ–∑–∞–ª–∏) */
    .row2{
      display:grid;
      grid-template-columns: 1.35fr 0.65fr; /* –±—ã–ª–æ 1fr 1fr */
      gap:14px;
      min-height:0;
    }

    .card{
      border:1px solid #eee;
      border-radius:14px;
      padding:14px;
      box-sizing:border-box;
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:22px;
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .pill{
      font-size:14px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fafafa;
    }

    .chartHost{ flex:1 1 auto; min-height:0; }

    .error{
      color:#b00020;
      background:#fff5f7;
      border:1px solid #ffd7dd;
      border-radius:12px;
      padding:14px;
      font-size:18px;
      line-height:1.35;
    }

    /* ========= –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ========= */
    .vchart{
      height:100%;
      display:grid;

      /* ‚Üì –î–ê–õ–ò –ë–û–õ–¨–®–ï –ú–ï–°–¢–ê –ü–û–î –ò–ú–ï–ù–ê */
      grid-template-rows: 22px 1fr 130px;  /* –±—ã–ª–æ ~90px */
      gap:8px;
      min-height:0;
    }

    .cap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:15px;
      opacity:.75;
      padding:0 6px;
      white-space:nowrap;
      user-select:none;
    }

    .plot{
      position:relative;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      min-height:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.08) 1px, transparent 1px);
      background-size:100% 20%;
    }

    .columns{
      position:absolute;
      inset:10px;
      display:grid;
      align-items:stretch;
      gap:6px;
      min-height:0;
    }

    .col{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      min-width:0;
    }

    .val{
      font-size:13px;
      font-weight:800;
      margin-bottom:4px;
      white-space:nowrap;
      user-select:none;
    }

    .bar{
      width:100%;
      height:0%;
      border-radius:8px 8px 0 0;
      transition:height .25s ease;
      min-height:2px;
    }

    /* ====== –ò–º–µ–Ω–∞: 1 —Å—Ç—Ä–æ–∫–∞, –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π. –î–µ–ª–∞–µ–º –Ω–∞–∫–ª–æ–Ω —Å–∏–ª—å–Ω–µ–µ –∏ –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã ====== */
    .xlabels{
      display:grid;
      gap:6px;
      padding:0 10px;
      overflow:visible;
      min-height:0;
    }

    .xlabel{
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;

      font-weight:800;
      font-size: clamp(11px, 0.95vw, 14px);
      line-height:1.05;
      text-align:center;

      /* ‚Üì –°–∏–ª—å–Ω–µ–µ –Ω–∞–∫–ª–æ–Ω ‚Äî –≤–ª–µ–∑–∞—é—Ç –¥–ª–∏–Ω–Ω—ã–µ —Ñ–∞–º–∏–ª–∏–∏ */
      transform: rotate(-55deg);
      transform-origin: top center;
      user-select:none;
    }

    /* ===== –¶–µ–ª—å ===== */
    .targetLine{
      position:absolute;
      left:0; right:0;
      height:2px;
      background:#e11d48;
      opacity:.85;
      pointer-events:none;
    }
    .targetLabel{
      position:absolute;
      right:8px;
      font-size:13px;
      font-weight:900;
      color:#e11d48;
      background:rgba(255,255,255,.92);
      padding:2px 6px;
      border-radius:999px;
      white-space:nowrap;
      pointer-events:none;
      transform: translateY(50%);
    }

    /* ========= –¢–∞–±–ª–∏—Ü–∞ —Å—É–º–º: –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ ========= */
    #sumTableWrap{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden; /* —É–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª */
    }

    .sumTable{
      width:100%;
      height:100%;
      border-collapse:collapse;
      table-layout:fixed;

      /* —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –≤–ª–µ–∑–ª–∏ 4 —Å—Ç—Ä–æ–∫–∏ */
      font-size:18px;
    }

    .sumTable th, .sumTable td{
      border:2px solid #222;
      padding:6px 8px;
      line-height:1.0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:middle;
    }

    .sumHead{
      background:#93c47d;
      font-size:20px;
      font-weight:900;
      text-align:center;
    }

    .sumLabel{ font-weight:900; text-align:center; }
    .sumVal{ font-weight:900; text-align:right; font-variant-numeric: tabular-nums; }

    @media (max-width: 900px){
      .row2{ grid-template-columns:1fr; }
      .vchart{ grid-template-rows: 22px 1fr 140px; }
      .xlabel{ transform: rotate(-60deg); }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Bonus dashboard</div>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>RU <span class="pill">–¥–∞–Ω–Ω—ã–µ!G2:H28</span></h2>
      <div id="chartRU" class="chartHost"></div>
    </div>

    <div class="row2">
      <div class="card">
        <h2>ENG / PL <span class="pill">–¥–∞–Ω–Ω—ã–µ!C2:D8</span></h2>
        <div id="chartENGPL" class="chartHost"></div>
      </div>

      <div class="card">
        <h2>Team ratings <span class="pill">–¥–∞–Ω–Ω—ã–µ!P18:Q21</span></h2>
        <div id="sumTableWrap"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SPREADSHEET_ID = "123_11_j3y3KJhh45yomAOSFp3qP0Un7ePHxjcXQEhfs";
  const GID = "1932060383";

  const TARGET = 150000;
  const REFRESH_MS = 30000;

  const RANGES = {
    ru: "G2:H28",
    engpl: "C2:D8",
    sums: "P18:Q21",
  };

  const statusEl = document.getElementById("status");
  const chartRU = document.getElementById("chartRU");
  const chartENGPL = document.getElementById("chartENGPL");
  const sumTableWrap = document.getElementById("sumTableWrap");

  function csvUrl(range) {
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/export?format=csv&gid=${encodeURIComponent(GID)}&range=${encodeURIComponent(range)}&t=${Date.now()}`;
  }

  function parseCSV(text) {
    if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (ch === "\n" && !inQuotes) {
        row.push(cell); rows.push(row);
        row = []; cell = "";
        continue;
      }
      if (ch === "\r") continue;

      if (ch === "," && !inQuotes) { row.push(cell); cell = ""; continue; }
      cell += ch;
    }
    row.push(cell); rows.push(row);

    return rows
      .map(r => (r || []).map(v => (v ?? "").trim()))
      .filter(r => r.length >= 2 && !(r[0] === "" && r[1] === ""));
  }

  function toNumber(v) {
    const s = String(v ?? "").replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function hashString(s) {
    s = String(s ?? "");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function colorForName(name) {
    const h = hashString(name) % 360;
    return `hsl(${h} 70% 45%)`;
  }

  // –û—Å—å –ø–æ –¥–∞–Ω–Ω—ã–º (–∫–∞–∫ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Äî —Å—Ç–æ–ª–±–∏–∫–∏ –Ω–∞–≥–ª—è–¥–Ω—ã–µ)
  function niceMax(v) {
    if (v <= 0) return 1;
    const exp = Math.pow(10, Math.floor(Math.log10(v)));
    const frac = v / exp;
    let niceFrac;
    if (frac <= 1) niceFrac = 1;
    else if (frac <= 2) niceFrac = 2;
    else if (frac <= 5) niceFrac = 5;
    else niceFrac = 10;
    return niceFrac * exp;
  }

  function renderVerticalChart(container, pairs) {
    let items = pairs.map(r => ({ name: r[0] ?? "", value: toNumber(r[1]) }));
    items.sort((a,b) => b.value - a.value);

    const maxData = Math.max(0, ...items.map(x => x.value));
    const axisMax = niceMax(maxData || 1);

    const showTargetInside = TARGET <= axisMax;
    const targetPct = showTargetInside ? (TARGET / axisMax) * 100 : 100;

    container.innerHTML = `
      <div class="vchart">
        <div class="cap">
          <div>0</div>
          <div>MAX (–æ—Å—å): ${esc(axisMax)} ‚Ä¢ –¶–ï–õ–¨ ${esc(TARGET)}${showTargetInside ? "" : " (–≤—ã—à–µ)"}</div>
        </div>

        <div class="plot">
          ${showTargetInside ? `
            <div class="targetLine" style="bottom:${targetPct}%;"></div>
            <div class="targetLabel" style="bottom:${targetPct}%;">–¶–ï–õ–¨ ${esc(TARGET)}</div>
          ` : `
            <div class="targetLabel" style="top:10px; transform:none;">–¶–ï–õ–¨ ${esc(TARGET)} (–≤—ã—à–µ)</div>
          `}
          <div class="columns"></div>
        </div>

        <div class="xlabels"></div>
      </div>
    `;

    const colsEl = container.querySelector(".columns");
    const labelsEl = container.querySelector(".xlabels");

    colsEl.style.gridTemplateColumns = `repeat(${items.length}, 1fr)`;
    labelsEl.style.gridTemplateColumns = `repeat(${items.length}, 1fr)`;

    colsEl.innerHTML = items.map(it => {
      const pct = Math.max(0, Math.min(100, (it.value / axisMax) * 100));
      const h = it.value === 0 ? 2 : Math.max(2, pct);
      return `
        <div class="col">
          <div class="val">${esc(it.value)}</div>
          <div class="bar" style="height:${h}%; background:${colorForName(it.name)};"></div>
        </div>
      `;
    }).join("");

    labelsEl.innerHTML = items.map(it =>
      `<div class="xlabel" title="${esc(it.name)}">${esc(it.name)}</div>`
    ).join("");
  }

  function renderSumsTable(pairs) {
    const rows = pairs.slice(0, 4).map(r => [r[0] ?? "", toNumber(r[1])]);

    sumTableWrap.innerHTML = `
      <table class="sumTable">
        <thead>
          <tr><th class="sumHead" colspan="2">Team ratings üìä</th></tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td class="sumLabel">${esc(r[0])}</td>
              <td class="sumVal">${esc(r[1])}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function loadAll() {
    try {
      statusEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const [ruText, engplText, sumsText] = await Promise.all([
        fetch(csvUrl(RANGES.ru), { cache:"no-store" }).then(r => r.text()),
        fetch(csvUrl(RANGES.engpl), { cache:"no-store" }).then(r => r.text()),
        fetch(csvUrl(RANGES.sums), { cache:"no-store" }).then(r => r.text()),
      ]);

      const ru = parseCSV(ruText);
      const engpl = parseCSV(engplText);
      const sums = parseCSV(sumsText);

      renderVerticalChart(chartRU, ru);
      renderVerticalChart(chartENGPL, engpl);
      renderSumsTable(sums);

      statusEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
    } catch (e) {
      chartRU.innerHTML = `<div class="error">${esc(e.message)}</div>`;
      chartENGPL.innerHTML = `<div class="error">${esc(e.message)}</div>`;
      sumTableWrap.innerHTML = `<div class="error">${esc(e.message)}</div>`;
      statusEl.textContent = "–û—à–∏–±–∫–∞";
    }
  }

  loadAll();
  setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>
