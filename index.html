<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonus Dashboard</title>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:#fff; font-family: Arial, sans-serif; }
    .wrap { height:100vh; display:flex; flex-direction:column; }
    .topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
    .title { font-weight:700; font-size:18px; }
    .status { opacity:.75; font-size:14px; white-space:nowrap; }

    .grid { flex:1; display:grid; grid-template-rows: 2fr 1fr; gap:14px; padding:14px 16px; box-sizing:border-box; min-height:0; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; min-height:0; }

    .card { border:1px solid #eee; border-radius:12px; padding:14px; box-sizing:border-box; min-height:0; overflow:hidden; }
    .card h2 { margin:0 0 10px 0; font-size:18px; display:flex; align-items:center; gap:10px; }
    .pill { font-size:14px; padding:3px 10px; border-radius:999px; border:1px solid #eee; background:#fafafa; }

    .error { color:#b00020; background:#fff5f7; border:1px solid #ffd7dd; border-radius:10px; padding:12px; font-size:16px; line-height:1.35; }

    /* ===== –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ ===== */
    .vchart {
      height: 100%;
      display: grid;
      grid-template-rows: 24px 1fr 64px;
      gap: 8px;
      overflow: hidden;
    }

    .cap {
      display:flex;
      justify-content:space-between;
      font-size:14px;
      opacity:.78;
      padding: 0 6px;
      user-select:none;
      white-space:nowrap;
    }

    .plot {
      position: relative;
      border: 1px solid #eee;
      border-radius: 10px;
      overflow: hidden;
      background:
        linear-gradient(to bottom, rgba(0,0,0,0.08) 1px, transparent 1px);
      background-size: 100% 20%;
    }

    /* –ª–∏–Ω–∏—è —Ü–µ–ª–∏ */
    .targetLine {
      position:absolute;
      left:0; right:0;
      height:2px;
      background:#e11d48;
      opacity:0.85;
      pointer-events:none;
    }
    .targetLabel {
      position:absolute;
      right:10px;
      transform: translateY(-50%);
      font-size:12px;
      font-weight:700;
      color:#e11d48;
      background: rgba(255,255,255,0.9);
      padding:2px 6px;
      border-radius:999px;
      pointer-events:none;
    }

    .columns {
      position: absolute;
      inset: 10px 10px 10px 10px;
      display: grid;
      align-items: end;
      gap: 4px;
    }

    .col {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      min-width:0;
    }

    .val {
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      margin-bottom: 4px;
      opacity: .9;
      user-select:none;
      white-space:nowrap;
    }

    .bar {
      width: 100%;
      height: 0%;
      border-radius: 6px 6px 0 0;
      transition: height .35s ease;
      min-height: 2px; /* –Ω—É–ª–∏ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ç–æ–Ω–∫–æ–π –ª–∏–Ω–∏–µ–π */
    }

    .xlabels {
      display: grid;
      gap: 4px;
      align-items: start;
      padding: 0 10px 0 10px;
      user-select:none;
    }

    .xlabel {
      font-size: 12px;
      text-align:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      transform: rotate(-25deg);
      transform-origin: top center;
      line-height: 1.1;
    }

    /* ===== –¢–∞–±–ª–∏—Ü–∞ —Å—É–º–º ===== */
    .sumTable {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:22px;
    }
    .sumTable th, .sumTable td {
      border:2px solid #222;
      padding:12px 14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sumHead {
      background:#93c47d;
      color:#000;
      font-weight:800;
      text-align:center;
      font-size:26px;
      letter-spacing:.2px;
    }
    .sumLabel { font-weight:800; text-align:center; }
    .sumVal { text-align:right; font-variant-numeric: tabular-nums; }

    @media (max-width: 900px) {
      .row2 { grid-template-columns: 1fr; }
      .sumTable { font-size:18px; }
      .sumHead { font-size:22px; }
      .xlabel { font-size: 11px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Bonus dashboard</div>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>RU <span class="pill">–¥–∞–Ω–Ω—ã–µ!G2:H28</span></h2>
      <div id="chartRU" style="height:100%;"></div>
    </div>

    <div class="row2">
      <div class="card">
        <h2>ENG / PL <span class="pill">–¥–∞–Ω–Ω—ã–µ!C2:D8</span></h2>
        <div id="chartENGPL" style="height:100%;"></div>
      </div>

      <div class="card">
        <h2>Team ratings <span class="pill">–¥–∞–Ω–Ω—ã–µ!P18:Q21</span></h2>
        <div id="sumTableWrap" style="height:100%; overflow:auto;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SPREADSHEET_ID = "123_11_j3y3KJhh45yomAOSFp3qP0Un7ePHxjcXQEhfs";
  const GID_DANNYE = "1932060383";

  const RANGE_RU    = "G2:H28";
  const RANGE_ENGPL = "C2:D8";
  const RANGE_SUMS  = "P18:Q21";

  const TARGET = 150000;        // —Ü–µ–ª—å (–ª–∏–Ω–∏—è)
  const REFRESH_MS = 30000;

  const statusEl = document.getElementById("status");
  const chartRU = document.getElementById("chartRU");
  const chartENGPL = document.getElementById("chartENGPL");
  const sumTableWrap = document.getElementById("sumTableWrap");

  function setStatus(t){ statusEl.textContent = t; }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function parseCSV(text) {
    if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (ch === "\n" && !inQuotes) { row.push(cell); rows.push(row); row=[]; cell=""; continue; }
      if (ch === "\r") continue;

      if (ch === "," && !inQuotes) { row.push(cell); cell=""; continue; }

      cell += ch;
    }
    row.push(cell);
    rows.push(row);

    while (rows.length && rows[rows.length-1].every(v => (v ?? "").trim() === "")) rows.pop();
    return rows;
  }

  function toNumber(x) {
    const s = String(x ?? "").replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function rangeCsvUrl(gid, range) {
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/export?format=csv&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent(range)}`;
  }

  async function fetchRange(gid, range) {
    const url = rangeCsvUrl(gid, range) + `&t=${Date.now()}`;
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const rows = parseCSV(text);

    return rows
      .map(r => (r || []).map(v => (v ?? "").trim()))
      .filter(r => r.length >= 2 && !(r[0] === "" && r[1] === ""));
  }

  // –¶–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏ (—Å—Ç–∞–±–∏–ª—å–Ω–æ)
  function hashString(s) {
    s = String(s ?? "");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function colorForName(name) {
    const h = hashString(name) % 360;
    return `hsl(${h} 70% 45%)`;
  }

  // "–∫—Ä–∞—Å–∏–≤—ã–π" –º–∞–∫—Å–∏–º—É–º –æ—Å–∏ Y –∫–∞–∫ –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö: –æ–∫—Ä—É–≥–ª–∏—Ç—å –≤–≤–µ—Ä—Ö –¥–æ —à–∞–≥–∞
  function niceMax(v) {
    if (v <= 0) return 1;
    const exp = Math.pow(10, Math.floor(Math.log10(v)));
    const frac = v / exp;
    let niceFrac;
    if (frac <= 1) niceFrac = 1;
    else if (frac <= 2) niceFrac = 2;
    else if (frac <= 5) niceFrac = 5;
    else niceFrac = 10;
    return niceFrac * exp;
  }

  function renderVerticalChart(container, pairs, target) {
    if (!pairs || pairs.length === 0) {
      container.innerHTML = `<div class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã.</div>`;
      return;
    }

    let items = pairs.map(r => ({ name: r[0] ?? "", value: toNumber(r[1]) }));
    items.sort((a,b) => b.value - a.value);

    const maxData = Math.max(0, ...items.map(x => x.value));
    const axisMax = niceMax(maxData);            // –∫–∞–∫ ‚Äú–≤ —Å—Ç–∞—Ä–æ–º‚Äù ‚Äî –ø–æ –¥–∞–Ω–Ω—ã–º
    const targetPct = (target / axisMax) * 100;  // –ª–∏–Ω–∏—è —Ü–µ–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Å–∏

    // –µ—Å–ª–∏ —Ü–µ–ª—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ (–≤—ã—à–µ axisMax) ‚Äî –ø–æ–∫–∞–∂–µ–º –µ—ë –∫–∞–∫ "–≤—ã—à–µ –≥—Ä–∞—Ñ–∏–∫–∞"
    const showTargetInside = target <= axisMax;

    const cols = items.length;

    container.innerHTML = `
      <div class="vchart">
        <div class="cap">
          <div>0</div>
          <div>MAX (–æ—Å—å): ${escapeHtml(String(axisMax))}${showTargetInside ? "" : ` ‚Ä¢ –¶–ï–õ–¨: ${escapeHtml(String(target))}`}</div>
        </div>
        <div class="plot">
          ${showTargetInside ? `
            <div class="targetLine" style="bottom:${targetPct}%;"></div>
            <div class="targetLabel" style="bottom:${targetPct}%; transform: translateY(50%);">–¶–ï–õ–¨ ${escapeHtml(String(target))}</div>
          ` : `
            <div class="targetLabel" style="top:10px;">–¶–ï–õ–¨ ${escapeHtml(String(target))} (–≤—ã—à–µ)</div>
          `}
          <div class="columns" id="cols"></div>
        </div>
        <div class="xlabels" id="xlabels"></div>
      </div>
    `;

    const colsEl = container.querySelector("#cols");
    const xlabelsEl = container.querySelector("#xlabels");
    colsEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    xlabelsEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    colsEl.innerHTML = items.map(it => {
      const pct = Math.max(0, Math.min(100, (it.value / axisMax) * 100));
      const col = colorForName(it.name);
      const heightPct = (it.value === 0) ? 2 : pct;
      return `
        <div class="col">
          <div class="val">${escapeHtml(String(it.value))}</div>
          <div class="bar" style="height:${heightPct}%; background:${col};"></div>
        </div>
      `;
    }).join("");

    xlabelsEl.innerHTML = items.map(it => {
      return `<div class="xlabel" title="${escapeHtml(it.name)}">${escapeHtml(it.name)}</div>`;
    }).join("");
  }

  function renderSumsTable(pairs) {
    if (!pairs || pairs.length === 0) {
      sumTableWrap.innerHTML = `<div class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å—É–º–º.</div>`;
      return;
    }

    let html = `
      <table class="sumTable">
        <thead>
          <tr><th class="sumHead" colspan="2">Team ratings üìä</th></tr>
        </thead>
        <tbody>
    `;

    for (const r of pairs) {
      const label = r[0] ?? "";
      const value = toNumber(r[1]);
      html += `
        <tr>
          <td class="sumLabel">${escapeHtml(label)}</td>
          <td class="sumVal">${escapeHtml(String(value))}</td>
        </tr>
      `;
    }

    html += `</tbody></table>`;
    sumTableWrap.innerHTML = html;
  }

  async function loadAll() {
    try {
      setStatus("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶");

      const [ru, engpl, sums] = await Promise.all([
        fetchRange(GID_DANNYE, RANGE_RU),
        fetchRange(GID_DANNYE, RANGE_ENGPL),
        fetchRange(GID_DANNYE, RANGE_SUMS),
      ]);

      // ‚úÖ ‚Äú–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ‚Äù: –æ—Å—å –ø–æ –¥–∞–Ω–Ω—ã–º + –ª–∏–Ω–∏—è —Ü–µ–ª–∏ 150k
      renderVerticalChart(chartRU, ru, TARGET);
      renderVerticalChart(chartENGPL, engpl, TARGET);

      renderSumsTable(sums);

      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      setStatus(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${hh}:${mm}:${ss}`);
    } catch (e) {
      chartRU.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ RU: ${escapeHtml(e.message)}</div>`;
      chartENGPL.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ ENG/PL: ${escapeHtml(e.message)}</div>`;
      sumTableWrap.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å—É–º–º: ${escapeHtml(e.message)}</div>`;
      setStatus("–û—à–∏–±–∫–∞");
    }
  }

  loadAll();
  setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>
