<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonus Dashboard</title>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:#fff; font-family: Arial, sans-serif; }
    .wrap { height:100vh; display:flex; flex-direction:column; }
    .topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
    .title { font-weight:700; font-size:18px; }
    .status { opacity:.75; font-size:14px; white-space:nowrap; }

    .grid { flex:1; display:grid; grid-template-rows: 2fr 1fr; gap:14px; padding:14px 16px; box-sizing:border-box; min-height:0; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; min-height:0; }

    .card { border:1px solid #eee; border-radius:12px; padding:14px; box-sizing:border-box; min-height:0; overflow:hidden; }
    .card h2 { margin:0 0 10px 0; font-size:18px; display:flex; align-items:center; gap:10px; }
    .pill { font-size:14px; padding:3px 10px; border-radius:999px; border:1px solid #eee; background:#fafafa; }

    .chart { height:100%; overflow:auto; display:flex; flex-direction:column; gap:10px; }

    .barrow { display:grid; grid-template-columns: 280px 1fr 90px; gap:12px; align-items:center; font-size:18px; }
    .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .barwrap { height:18px; background:#f2f2f2; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0%; background:#111; border-radius:999px; transition:width .35s ease; }
    .val { text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap; }

    .error { color:#b00020; background:#fff5f7; border:1px solid #ffd7dd; border-radius:10px; padding:12px; font-size:16px; line-height:1.35; }

    /* –¢–∞–±–ª–∏—Ü–∞ —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É (—Å—É–º–º—ã) ‚Äî –±–ª–∏–∂–µ –∫ —Ç–≤–æ–µ–º—É –≤–∏–¥—É */
    .sumTable {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:22px;
    }
    .sumTable th, .sumTable td {
      border:2px solid #222;
      padding:12px 14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sumHead {
      background:#93c47d; /* —Å–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π –∫–∞–∫ –≤ —Ç–≤–æ—ë–º –ø—Ä–∏–º–µ—Ä–µ */
      color:#000;
      font-weight:800;
      text-align:center;
      font-size:26px;
      letter-spacing:.2px;
    }
    .sumLabel { font-weight:800; text-align:center; }
    .sumVal { text-align:right; font-variant-numeric: tabular-nums; }

    @media (max-width: 900px) {
      .barrow { grid-template-columns: 1fr 1fr 70px; }
      .row2 { grid-template-columns: 1fr; }
      .sumTable { font-size:18px; }
      .sumHead { font-size:22px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Bonus dashboard</div>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>RU <span class="pill">–¥–∞–Ω–Ω—ã–µ!G2:H28</span></h2>
      <div class="chart" id="chartRU"></div>
    </div>

    <div class="row2">
      <div class="card">
        <h2>ENG / PL <span class="pill">–¥–∞–Ω–Ω—ã–µ!C2:D8</span></h2>
        <div class="chart" id="chartENGPL"></div>
      </div>

      <div class="card">
        <h2>Team ratings <span class="pill">–¥–∞–Ω–Ω—ã–µ!P18:Q21</span></h2>
        <div id="sumTableWrap" style="height:100%; overflow:auto;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ‚úÖ ID —Ç–∞–±–ª–∏—Ü—ã
  const SPREADSHEET_ID = "123_11_j3y3KJhh45yomAOSFp3qP0Un7ePHxjcXQEhfs";

  // ‚úÖ gid –ª–∏—Å—Ç–∞ "–¥–∞–Ω–Ω—ã–µ"
  const GID_DANNYE = "1932060383";

  // –î–∏–∞–ø–∞–∑–æ–Ω—ã
  const RANGE_RU      = "G2:H28";
  const RANGE_ENGPL   = "C2:D8";
  const RANGE_SUMS    = "P18:Q21";

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  const REFRESH_MS = 30000;

  const statusEl = document.getElementById("status");
  const chartRU = document.getElementById("chartRU");
  const chartENGPL = document.getElementById("chartENGPL");
  const sumTableWrap = document.getElementById("sumTableWrap");

  function setStatus(t){ statusEl.textContent = t; }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function parseCSV(text) {
    if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (ch === "\n" && !inQuotes) { row.push(cell); rows.push(row); row=[]; cell=""; continue; }
      if (ch === "\r") continue;

      if (ch === "," && !inQuotes) { row.push(cell); cell=""; continue; }

      cell += ch;
    }
    row.push(cell);
    rows.push(row);

    while (rows.length && rows[rows.length-1].every(v => (v ?? "").trim() === "")) rows.pop();
    return rows;
  }

  function toNumber(x) {
    const s = String(x ?? "").replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // ‚úÖ export CSV –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É
  function rangeCsvUrl(gid, range) {
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/export?format=csv&gid=${encodeURIComponent(gid)}&range=${encodeURIComponent(range)}`;
  }

  async function fetchRange(gid, range) {
    const url = rangeCsvUrl(gid, range) + `&t=${Date.now()}`;
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const rows = parseCSV(text);

    return rows
      .map(r => (r || []).map(v => (v ?? "").trim()))
      .filter(r => r.length >= 2 && !(r[0] === "" && r[1] === ""));
  }

  // üé® –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ü–≤–µ—Ç –ø–æ –∏–º–µ–Ω–∏ (–∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Å–≤–æ–π —Ü–≤–µ—Ç)
  function hashString(s) {
    s = String(s ?? "");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HSL ‚Äî –±—Ä–∞—É–∑–µ—Ä—É –ª–µ–≥–∫–æ, —Ü–≤–µ—Ç–∞ —Ä–∞–∑–Ω—ã–µ –∏ –ø—Ä–∏—è—Ç–Ω—ã–µ
  function colorForName(name) {
    const h = hashString(name) % 360;            // –æ—Ç—Ç–µ–Ω–æ–∫
    const sat = 70;                              // –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
    const light = 45;                            // —è—Ä–∫–æ—Å—Ç—å
    return `hsl(${h} ${sat}% ${light}%)`;
  }

  function renderBars(el, pairs, opts = {}) {
    const { topN = null, sortDesc = true } = opts;

    if (!pairs || pairs.length === 0) {
      el.innerHTML = `<div class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã.</div>`;
      return;
    }

    let items = pairs.map(r => ({ name: r[0] ?? "", value: toNumber(r[1]) }));

    // –Ω—É–ª–∏ –ù–ï —Å–∫—Ä—ã–≤–∞–µ–º (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª–∞)
    if (sortDesc) items.sort((a,b) => b.value - a.value);
    if (topN) items = items.slice(0, topN);

    const maxVal = Math.max(1, ...items.map(x => x.value));

    el.innerHTML = items.map(it => {
      const pct = Math.max(0, Math.min(100, (it.value / maxVal) * 100));
      const col = colorForName(it.name);
      return `
        <div class="barrow">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="barwrap"><div class="bar" style="width:${pct}%; background:${col};"></div></div>
          <div class="val">${escapeHtml(it.value)}</div>
        </div>
      `;
    }).join("");
  }

  function renderSumsTable(pairs) {
    // pairs: [ [label, value], ... ] –∏–∑ P18:Q21
    if (!pairs || pairs.length === 0) {
      sumTableWrap.innerHTML = `<div class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å—É–º–º.</div>`;
      return;
    }

    // –†–µ–Ω–¥–µ—Ä ‚Äú–∫–∞–∫ —É —Ç–µ–±—è‚Äù: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–µ–ª—ë–Ω—ã–π, –∂–∏—Ä–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏
    let html = `
      <table class="sumTable">
        <thead>
          <tr><th class="sumHead" colspan="2">Team ratings üìä</th></tr>
        </thead>
        <tbody>
    `;

    for (const r of pairs) {
      const label = r[0] ?? "";
      const value = toNumber(r[1]);
      html += `
        <tr>
          <td class="sumLabel">${escapeHtml(label)}</td>
          <td class="sumVal">${escapeHtml(value)}</td>
        </tr>
      `;
    }

    html += `</tbody></table>`;
    sumTableWrap.innerHTML = html;
  }

  async function loadAll() {
    try {
      setStatus("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶");

      const [ru, engpl, sums] = await Promise.all([
        fetchRange(GID_DANNYE, RANGE_RU),
        fetchRange(GID_DANNYE, RANGE_ENGPL),
        fetchRange(GID_DANNYE, RANGE_SUMS),
      ]);

      // RU ‚Äî –∫–∞–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö, –≤–∫–ª—é—á–∞—è –Ω—É–ª–∏
      renderBars(chartRU, ru, { topN: null, sortDesc: true });

      // ENG/PL ‚Äî —Ç–æ–∂–µ —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (–≤ —Ç.—á. –Ω—É–ª–∏)
      renderBars(chartENGPL, engpl, { topN: null, sortDesc: true });

      // –¢–∞–±–ª–∏—Ü–∞ —Å—É–º–º
      renderSumsTable(sums);

      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      setStatus(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${hh}:${mm}:${ss}`);
    } catch (e) {
      chartRU.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ RU: ${escapeHtml(e.message)}</div>`;
      chartENGPL.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ ENG/PL: ${escapeHtml(e.message)}</div>`;
      sumTableWrap.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å—É–º–º: ${escapeHtml(e.message)}</div>`;
      setStatus("–û—à–∏–±–∫–∞");
    }
  }

  loadAll();
  setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>
