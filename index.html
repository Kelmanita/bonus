<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonus Dashboard</title>

  <style>
    html, body {
      margin:0; padding:0;
      width:100vw; height:100vh;
      overflow:hidden;
      background:#fff;
      font-family: Arial, sans-serif;
    }
    body { font-size: 18px; }

    .wrap { height:100vh; display:flex; flex-direction:column; }

    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 18px;
      border-bottom:1px solid #eee;
    }
    .title{ font-size:22px; font-weight:800; }
    .status{ font-size:16px; opacity:.75; white-space:nowrap; }

    .grid{
      flex:1;
      display:grid;
      grid-template-rows: 2fr 1fr;
      gap:14px;
      padding:14px 18px;
      box-sizing:border-box;
      min-height:0;
    }

    .row2{
      display:grid;
    
      /* 3 –∫–æ–ª–æ–Ω–∫–∏:
         1) –¥–∏–∞–≥—Ä–∞–º–º–∞ ENG/PL (–≤ 2 —Ä–∞–∑–∞ —É–∂–µ)
         2) –ø—É—Å—Ç–æ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫
         3) —Ç–∞–±–ª–∏—Ü–∞ (–∫–∞–∫ –±—ã–ª–∞) */
      grid-template-columns: 0.7fr 1fr 0.65fr;
    
      gap:0;          /* gap —É–±–∏—Ä–∞–µ–º, –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π */
      min-height:0;
    }

    .row2 > .card:last-child{
      grid-column: 3;
    }


    .card{
      border:1px solid #eee;
      border-radius:14px;
      padding:14px;
      box-sizing:border-box;
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size:22px;
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .pill{
      font-size:14px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #eee;
      background:#fafafa;
    }

    .chartHost{ flex:1 1 auto; min-height:0; }

    /* ==== Chart wrapper ==== */
    .vwrap{
      height:100%;
      display:grid;
      grid-template-rows: 22px 1fr 120px;
      gap:8px;
    }

    .vwrap.compact{
      grid-template-rows: 22px 1fr 140px;  /* –±—ã–ª–æ 90/120 ‚Äî –¥–µ–ª–∞–µ–º –±–æ–ª—å—à–µ */
    }

    .cap{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:15px;
      opacity:.75;
      padding:0 6px;
      white-space:nowrap;
      user-select:none;
    }

    .plot{
      position:relative;
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.08) 1px, transparent 1px);
      background-size:100% 20%;
    }

    canvas{
      width:100%;
      height:100%;
      display:block;
    }

    .targetLabel{
      position:absolute;
      right:8px;
      font-size:13px;
      font-weight:900;
      color:#e11d48;
      background:rgba(255,255,255,.92);
      padding:2px 6px;
      border-radius:999px;
      white-space:nowrap;
      pointer-events:none;
    }
    .targetLine{
      position:absolute;
      left:0; right:0;
      height:2px;
      background:#e11d48;
      opacity:.85;
      pointer-events:none;
    }

    /* ==== Labels ==== */
    .xlabels{
      display:grid;
      gap:6px;
      padding: 6px 10px 0px 10px;
      overflow: visible;
      align-items: center;
    }

    .xlabels.compact{
      padding-top: 18px;   /* –±—ã–ª–æ 6px ‚Äî –æ–ø—É—Å–∫–∞–µ–º –Ω–∏–∂–µ */
    }
    
    .xlabel{
      display:block;
      width:100%;
      text-align:center;
      white-space:nowrap;
      font-weight:900;
      font-size: 18px;
      line-height:1.05;

      transform: translateX(-10px) rotate(-60deg);
      transform-origin: center;
      user-select:none;
    }

    /* ==== ENG/PL: —É–∑–∫–∏–µ —Å—Ç–æ–ª–±–∏–∫–∏ –ø–æ —à–∏—Ä–∏–Ω–µ (—Ç–æ–ª—å–∫–æ –ª–µ–π–±–ª—ã –∏ —Ä–∞—Å—á—ë—Ç—ã, canvas —Å–∞–º —Ä–∏—Å—É–µ—Ç) ==== */
    .xlabels.compact{
      display:flex;
      justify-content:center;
      gap:40px;                 /* –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å gap –≤ canvas */
      padding: 6px 30px 0 30px;
    }
    
    .xlabels.compact .xlabel{
      width:48px;               /* –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å barW –≤ canvas (compact) */
      text-align:center;
      transform: translateX(-2px) rotate(-60deg); /* —É–±–∏—Ä–∞–µ–º translateX, –æ–Ω –ø–æ—Ä—Ç–∏—Ç —Ü–µ–Ω—Ç—Ä */
      transform-origin: center;
    }

    /* ========= –¢–∞–±–ª–∏—Ü–∞ —Å—É–º–º ========= */
    #sumTableWrap{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }

    .sumTable{
      width:100%;
      height:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:18px;
    }

    .sumTable th, .sumTable td{
      border:2px solid #222;
      padding:6px 8px;
      line-height:1.0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:middle;
    }

    .sumHead{
      background:#93c47d;
      font-size:20px;
      font-weight:900;
      text-align:center;
    }

    .sumLabel{ font-weight:900; text-align:center; }
    .sumVal{ font-weight:900; text-align:right; font-variant-numeric: tabular-nums; }

    @media (max-width: 900px){
      .row2{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">Bonus dashboard</div>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>RU <span class="pill">–¥–∞–Ω–Ω—ã–µ!G2:H28</span></h2>
      <div id="chartRU" class="chartHost"></div>
    </div>

    <div class="row2">
      <div class="card">
        <h2>ENG / PL <span class="pill">–¥–∞–Ω–Ω—ã–µ!C2:D8</span></h2>
        <div id="chartENGPL" class="chartHost"></div>
      </div>

      <div class="card">
        <h2>Team ratings <span class="pill">–¥–∞–Ω–Ω—ã–µ!P18:Q21</span></h2>
        <div id="sumTableWrap"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SPREADSHEET_ID = "123_11_j3y3KJhh45yomAOSFp3qP0Un7ePHxjcXQEhfs";
  const GID = "1932060383";

  const TARGET = 150000;
  const REFRESH_MS = 30000;

  // === –í–´–ë–ï–†–ò –†–ï–ñ–ò–ú –í–ò–î–ò–ú–û–°–¢–ò –ú–ê–õ–´–• –ó–ù–ê–ß–ï–ù–ò–ô ===
  // true = ‚Äú–∫–∞–∫ Excel –Ω–∞–≥–ª—è–¥–Ω–æ‚Äù (–º–∞–ª—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–∏–¥–Ω—ã –º–∏–Ω–∏–º—É–º 1.2% –≤—ã—Å–æ—Ç—ã)
  // false = —Å—Ç—Ä–æ–≥–æ —á–µ—Å—Ç–Ω–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è
  const MAKE_SMALL_VALUES_VISIBLE = true;
  const MIN_VISIBLE_PCT = 1.2;   // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∏–¥–∏–º–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç–æ–ª–±–∏–∫–∞ –≤ %

  const RANGES = {
    ru: "G2:H28",
    engpl: "C2:D8",
    sums: "P18:Q21",
  };

  const statusEl = document.getElementById("status");
  const chartRU = document.getElementById("chartRU");
  const chartENGPL = document.getElementById("chartENGPL");
  const sumTableWrap = document.getElementById("sumTableWrap");

  function csvUrl(range) {
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/export?format=csv&gid=${encodeURIComponent(GID)}&range=${encodeURIComponent(range)}&t=${Date.now()}`;
  }

  function parseCSV(text) {
    if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (ch === "\n" && !inQuotes) {
        row.push(cell); rows.push(row);
        row = []; cell = "";
        continue;
      }
      if (ch === "\r") continue;

      if (ch === "," && !inQuotes) { row.push(cell); cell = ""; continue; }
      cell += ch;
    }
    row.push(cell); rows.push(row);

    return rows
      .map(r => (r || []).map(v => (v ?? "").trim()))
      .filter(r => r.length >= 2 && !(r[0] === "" && r[1] === ""));
  }

  function toNumber(v) {
    const s = String(v ?? "").replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function hashString(s) {
    s = String(s ?? "");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function colorForName(name) {
    const h = hashString(name) % 360;
    return `hsl(${h} 70% 45%)`;
  }

  function niceMax(v) {
    if (v <= 0) return 1;
    const exp = Math.pow(10, Math.floor(Math.log10(v)));
    const frac = v / exp;
    let niceFrac;
    if (frac <= 1) niceFrac = 1;
    else if (frac <= 2) niceFrac = 2;
    else if (frac <= 5) niceFrac = 5;
    else niceFrac = 10;
    return niceFrac * exp;
  }

  function draw3DBar(ctx, x, y, w, h, color) {
    // ‚ÄúExcel-like‚Äù 3D: front + top + side
    const depth = Math.min(10, Math.max(4, w * 0.18));
    const top = Math.min(10, Math.max(4, w * 0.18));

    // front
    ctx.fillStyle = color;
    ctx.fillRect(x, y, w, h);

    // top face (lighter)
    ctx.fillStyle = "rgba(255,255,255,0.28)";
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + top, y - top);
    ctx.lineTo(x + w, y - top);
    ctx.lineTo(x + w - top, y);
    ctx.closePath();
    ctx.fill();

    // side face (darker)
    ctx.fillStyle = "rgba(0,0,0,0.18)";
    ctx.beginPath();
    ctx.moveTo(x + w, y);
    ctx.lineTo(x + w, y + h);
    ctx.lineTo(x + w + depth, y + h - top);
    ctx.lineTo(x + w + depth, y - top);
    ctx.closePath();
    ctx.fill();

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.fillRect(x, y + h, w, 6);
  }

  function renderCanvasChart(container, pairs, opts = {}) {
    const compact = !!opts.compact;

    let items = pairs.map(r => ({ name: r[0] ?? "", value: toNumber(r[1]) }));
    items.sort((a,b) => b.value - a.value);

    const maxData = Math.max(0, ...items.map(x => x.value));
    const axisMax = niceMax(maxData || 1);

    const showTargetInside = TARGET <= axisMax;
    const targetPct = showTargetInside ? (TARGET / axisMax) * 100 : 100;

    container.innerHTML = `
      <div class="vwrap ${compact ? "compact" : ""}">
        <div class="cap">
          <div>0</div>
          <div>MAX (–æ—Å—å): ${esc(axisMax)} ‚Ä¢ –¶–ï–õ–¨ ${esc(TARGET)}${showTargetInside ? "" : " (–≤—ã—à–µ)"}</div>
        </div>

        <div class="plot">
          ${showTargetInside ? `
            <div class="targetLine" style="bottom:${targetPct}%;"></div>
            <div class="targetLabel" style="bottom:${targetPct}%; transform:translateY(50%);">–¶–ï–õ–¨ ${esc(TARGET)}</div>
          ` : `
            <div class="targetLabel" style="top:10px; transform:none;">–¶–ï–õ–¨ ${esc(TARGET)} (–≤—ã—à–µ)</div>
          `}
          <canvas></canvas>
        </div>

        <div class="xlabels ${compact ? "compact" : ""}"></div>
      </div>
    `;

    const plot = container.querySelector(".plot");
    const canvas = container.querySelector("canvas");
    const labelsEl = container.querySelector(".xlabels");

    // labels
    if (compact) {
      labelsEl.innerHTML = items.map(it => `<div class="xlabel" title="${esc(it.name)}">${esc(it.name)}</div>`).join("");
    } else {
      labelsEl.style.gridTemplateColumns = `repeat(${items.length}, 1fr)`;
      labelsEl.innerHTML = items.map(it => `<div class="xlabel" title="${esc(it.name)}">${esc(it.name)}</div>`).join("");
    }

    function redraw() {
      const rect = plot.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,rect.width,rect.height);

      // layout paddings inside plot
      const padL = 14, padR = 22, padT = 14, padB = 22;
      const W = rect.width - padL - padR;
      const H = rect.height - padT - padB;

      // platform (oldschool)
      ctx.fillStyle = "rgba(0,0,0,0.06)";
      ctx.fillRect(padL, padT + H + 6, W, 10);

      // bar sizing
      const n = items.length;
      const gap = compact ? 40 : 8;
      const barW = compact ? 48 : Math.max(10, Math.floor((W - gap*(n-1)) / n));
      const totalW = compact ? (n * barW + (n-1)*gap) : (n * barW + (n-1)*gap);
      let startX = padL + Math.max(0, (W - totalW) / 2);

      // draw bars
      items.forEach((it, i) => {
        const rawPct = (it.value / axisMax) * 100;
        let pct = Math.max(0, Math.min(100, rawPct));

        // –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç—å –º–∞–ª—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        if (MAKE_SMALL_VALUES_VISIBLE && it.value > 0) {
          pct = Math.max(pct, MIN_VISIBLE_PCT);
        }

        const h = (pct/100) * H;

        const x = startX + i*(barW + gap);
        const y = padT + (H - h);

        const color = colorForName(it.name);

        // value label
        ctx.fillStyle = "#000";
        ctx.font = "700 12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(String(it.value), x + barW/2, Math.max(12, y - 6));

        // if zero -> draw tiny flat line
        if (it.value <= 0) {
          ctx.fillStyle = color;
          ctx.fillRect(x, padT + H - 2, barW, 2);
        } else {
          draw3DBar(ctx, x, y, barW, h, color);
        }
      });
    }

    redraw();
    window.addEventListener("resize", redraw, { passive:true });
  }

  function renderSumsTable(pairs) {
    const rows = pairs.slice(0, 4).map(r => [r[0] ?? "", toNumber(r[1])]);

    sumTableWrap.innerHTML = `
      <table class="sumTable">
        <thead>
          <tr><th class="sumHead" colspan="2">Team ratings üìä</th></tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td class="sumLabel">${esc(r[0])}</td>
              <td class="sumVal">${esc(r[1])}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function loadAll() {
    try {
      statusEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const [ruText, engplText, sumsText] = await Promise.all([
        fetch(csvUrl(RANGES.ru), { cache:"no-store" }).then(r => r.text()),
        fetch(csvUrl(RANGES.engpl), { cache:"no-store" }).then(r => r.text()),
        fetch(csvUrl(RANGES.sums), { cache:"no-store" }).then(r => r.text()),
      ]);

      const ru = parseCSV(ruText);
      const engpl = parseCSV(engplText);
      const sums = parseCSV(sumsText);

      renderCanvasChart(chartRU, ru, { compact:false });
      renderCanvasChart(chartENGPL, engpl, { compact:true });
      renderSumsTable(sums);

      statusEl.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
    } catch (e) {
      chartRU.innerHTML = `<div style="color:#b00020; padding:14px;">${esc(e.message)}</div>`;
      chartENGPL.innerHTML = `<div style="color:#b00020; padding:14px;">${esc(e.message)}</div>`;
      sumTableWrap.innerHTML = `<div style="color:#b00020; padding:14px;">${esc(e.message)}</div>`;
      statusEl.textContent = "–û—à–∏–±–∫–∞";
    }
  }

  loadAll();
  setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>





